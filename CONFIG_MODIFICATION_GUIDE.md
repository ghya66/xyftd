# 🔧 土豆担保 Telegram Bot 配置修改指南

> **版本**：1.0  
> **最后更新**：2024年12月  
> **适用对象**：Bot 管理员

---

## 📋 目录

1. [配置文件概览](#1-配置文件概览)
2. [修改文案内容](#2-修改文案内容-configtextsjson)
3. [修改收款地址](#3-修改收款地址-env)
4. [使用热加载命令](#4-使用热加载命令-reload)
5. [JSON 格式规范](#5-json-格式规范)
6. [占位符说明](#6-占位符说明)
7. [备份与恢复](#7-备份与恢复)
8. [故障排查](#8-故障排查)
9. [常见问题 FAQ](#9-常见问题-faq)

---

## 1. 配置文件概览

### 1.1 配置文件清单

| 文件 | 路径 | 作用 | 修改后生效方式 |
|------|------|------|----------------|
| 文案配置 | `config/texts.json` | 所有文案内容 | `/reload` 热加载 |
| 环境变量 | `.env` | 收款地址、Bot Token 等 | 重启 Bot |

### 1.2 修改权限要求

| 修改内容 | 所需权限 |
|----------|----------|
| 文案内容 | 服务器文件编辑权限 |
| 收款地址 | 服务器文件编辑权限 |
| 热加载命令 | Telegram 管理员权限（`ADMIN_USER_IDS`） |

---

## 2. 修改文案内容 (`config/texts.json`)

### 2.1 文件位置

```
项目根目录/config/texts.json
```

### 2.2 修改前准备

⚠️ **重要**：修改前请先备份原文件！

```bash
# 备份原文件
cp config/texts.json config/texts.json.backup
```

### 2.3 文件结构说明

```json
{
  "version": "1.0",                    // 配置版本号
  "description": "配置文件描述",        // 文件说明
  "welcome_message": "...",            // 欢迎消息（招聘信息）
  "menu_welcome": "...",               // 主菜单欢迎语
  "buttons": { ... },                  // 按钮文字配置
  "services": { ... },                 // 服务响应文案
  "human_responses": { ... },          // 人工客服回复模板
  "prompts": { ... }                   // 系统提示语
}
```

### 2.4 详细修改步骤

**步骤 1**：打开文件
```bash
# 使用任意文本编辑器打开
nano config/texts.json
# 或
vim config/texts.json
# 或使用 VS Code、Notepad++ 等
```

**步骤 2**：找到要修改的内容（见下方示例）

**步骤 3**：修改并保存文件

**步骤 4**：在 Telegram 中发送 `/reload` 命令热加载配置

**步骤 5**：验证修改是否生效

---

### 2.5 修改示例

#### 示例 1：修改欢迎消息（招聘信息）

**修改前：**
```json
{
  "welcome_message": "土豆担保华人线上招聘正式开启\n\n1️⃣ 公群广告删除员\n薪资：白班200U/天..."
}
```

**修改后：**
```json
{
  "welcome_message": "🥔 土豆担保2024年度招聘开启\n\n1️⃣ 公群广告删除员\n薪资：白班250U/天..."
}
```

| 对比项 | 修改前 | 修改后 |
|--------|--------|--------|
| 标题 | 土豆担保华人线上招聘正式开启 | 🥔 土豆担保2024年度招聘开启 |
| 薪资 | 白班200U/天 | 白班250U/天 |

---

#### 示例 2：修改按钮文字

**修改前：**
```json
{
  "buttons": {
    "la_zhuan": "拉专群",
    "kai_gong": "开公群"
  }
}
```

**修改后：**
```json
{
  "buttons": {
    "la_zhuan": "🔗 拉专群",
    "kai_gong": "🏠 开公群"
  }
}
```

| 对比项 | 修改前 | 修改后 |
|--------|--------|--------|
| 拉专群按钮 | 拉专群 | 🔗 拉专群 |
| 开公群按钮 | 开公群 | 🏠 开公群 |

---

#### 示例 3：修改服务价格（广告费用）

**位置**：`services.guanggao.text`

**修改前：**
```json
{
  "services": {
    "guanggao": {
      "type": "auto_reply_with_payment",
      "text": "土豆供需广告限时福利来了：\n\n收费标准：\n普通广告200U一条，包周1200U，包月4400U。\n公群广告100U一条..."
    }
  }
}
```

**修改后：**
```json
{
  "services": {
    "guanggao": {
      "type": "auto_reply_with_payment",
      "text": "土豆供需广告限时福利来了：\n\n收费标准：\n普通广告180U一条，包周1000U，包月4000U。\n公群广告80U一条..."
    }
  }
}
```

| 广告类型 | 修改前 | 修改后 |
|----------|--------|--------|
| 普通广告单条 | 200U | 180U |
| 普通广告包周 | 1200U | 1000U |
| 普通广告包月 | 4400U | 4000U |
| 公群广告单条 | 100U | 80U |

### 2.6 生效方式

✅ **热加载**：修改 `config/texts.json` 后，只需在 Telegram 中发送 `/reload` 命令即可生效，**无需重启 Bot**。

### 2.7 验证方法

1. 在 Telegram 中发送 `/reload` 命令
2. 收到成功提示：`✅ 配置重新加载成功！`
3. 发送 `/start` 测试欢迎消息
4. 点击对应按钮测试文案变化

### 2.8 常见错误

| 错误现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| `/reload` 提示加载失败 | JSON 格式错误 | 使用 JSON 验证工具检查格式 |
| 文案未变化 | 修改了错误的字段 | 检查字段名称是否正确 |
| 乱码显示 | 文件编码问题 | 确保使用 UTF-8 编码保存 |
| 特殊字符显示异常 | 未正确转义 | 检查引号、反斜杠等特殊字符 |

---

## 3. 修改收款地址 (`.env`)

### 3.1 文件位置

```
项目根目录/.env
```

### 3.2 修改前准备

⚠️ **重要**：修改收款地址需要重启 Bot！

```bash
# 备份原文件
cp .env .env.backup
```

### 3.3 详细修改步骤

**步骤 1**：打开 `.env` 文件
```bash
nano .env
# 或
vim .env
```

**步骤 2**：找到 `PAYMENT_ADDRESS` 配置项

**修改前：**
```env
# TRC20 USDT 收款地址
PAYMENT_ADDRESS=TWkdsUoYixY3N1RfHLUP2zqtT1uf7nUDPU
```

**修改后：**
```env
# TRC20 USDT 收款地址
PAYMENT_ADDRESS=TNewAddressXXXXXXXXXXXXXXXXXXXXXXX
```

**步骤 3**：保存文件

**步骤 4**：重启 Bot
```bash
# 停止当前 Bot
Ctrl+C

# 重新启动
python -m bot.main
```

**步骤 5**：验证修改

### 3.4 修改示例

| 对比项 | 修改前 | 修改后 |
|--------|--------|--------|
| PAYMENT_ADDRESS | `TWkdsUoYixY3N1RfHLUP2zqtT1uf7nUDPU` | `TNewAddressXXXXXXXXXXXXXXXXXXXXXXX` |

### 3.5 生效方式

⚠️ **需要重启 Bot**：收款地址配置在 `.env` 中，修改后必须重启 Bot 才能生效。

### 3.6 验证方法

1. 重启 Bot
2. 发送 `/config` 命令（需管理员权限）
3. 查看返回信息中的「收款地址」是否已更新
4. 点击「开公群」或「拉专群」等按钮，检查显示的地址是否正确

### 3.7 常见错误

| 错误现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 地址未变化 | 未重启 Bot | 停止并重新启动 Bot |
| Bot 启动失败 | `.env` 格式错误 | 检查是否有多余空格或引号 |
| 地址显示不完整 | 地址格式不正确 | 确认 TRC20 地址格式（34位字符） |

---

## 4. 使用热加载命令 (`/reload`)

### 4.1 命令说明

| 命令 | 功能 | 权限要求 |
|------|------|----------|
| `/reload` | 热加载 `config/texts.json` 配置文件 | 仅管理员 |
| `/config` | 查看当前配置信息 | 仅管理员 |

### 4.2 使用步骤

1. 修改 `config/texts.json` 文件并保存
2. 在 Telegram 中向 Bot 发送 `/reload`
3. 等待 Bot 回复

### 4.3 成功响应

```
✅ 配置重新加载成功！

📋 配置信息：
- 配置版本: 1.0
- 加载时间: 2024-12-08 12:00:00
- 服务数量: 10
```

### 4.4 失败响应

```
❌ 配置重新加载失败！

错误信息: JSON 解析错误，第 25 行存在语法问题
请检查配置文件格式后重试。
```

### 4.5 注意事项

⚠️ `/reload` 命令只能热加载 `config/texts.json` 中的文案配置。

以下配置修改后 **必须重启 Bot**：
- `.env` 中的 `PAYMENT_ADDRESS`
- `.env` 中的 `BOT_TOKEN`
- `.env` 中的 `ADMIN_USER_IDS`

---

## 5. JSON 格式规范

### 5.1 基本规则

| 规则 | 正确示例 | 错误示例 |
|------|----------|----------|
| 字符串用双引号 | `"hello"` | `'hello'` |
| 键名用双引号 | `"name": "value"` | `name: "value"` |
| 最后一项无逗号 | `"a": 1, "b": 2` ✅ | `"a": 1, "b": 2,` ❌ |
| 换行用 `\n` | `"line1\nline2"` | 实际换行 |

### 5.2 常见格式错误

#### ❌ 错误 1：最后一项多余逗号

```json
{
  "a": "1",
  "b": "2",   ← 错误！最后一项不能有逗号
}
```

#### ✅ 正确写法

```json
{
  "a": "1",
  "b": "2"
}
```

#### ❌ 错误 2：使用单引号

```json
{
  'name': 'value'   ← 错误！必须用双引号
}
```

#### ✅ 正确写法

```json
{
  "name": "value"
}
```

#### ❌ 错误 3：未转义特殊字符

```json
{
  "text": "这是"引号"测试"   ← 错误！引号未转义
}
```

#### ✅ 正确写法

```json
{
  "text": "这是\"引号\"测试"
}
```

### 5.3 JSON 验证工具

在修改前，建议使用以下工具验证 JSON 格式：

| 工具 | 网址 |
|------|------|
| JSONLint | https://jsonlint.com/ |
| JSON Editor Online | https://jsoneditoronline.org/ |
| VS Code JSON 插件 | 编辑器内置检查 |

---

## 6. 占位符说明

### 6.1 什么是占位符

占位符是文案中的特殊标记，Bot 在发送消息时会自动替换为实际值。

### 6.2 支持的占位符

| 占位符 | 说明 | 替换来源 |
|--------|------|----------|
| `{PAYMENT_ADDRESS}` | 收款地址 | `.env` 文件中的 `PAYMENT_ADDRESS` |

### 6.3 使用示例

**配置文件中的文案：**
```json
{
  "follow_up": "请将押金转入以下地址：\n\nTRC20地址：\n{PAYMENT_ADDRESS}\n\n转账完成后请发送截图"
}
```

**用户实际看到的消息：**
```
请将押金转入以下地址：

TRC20地址：
TWkdsUoYixY3N1RfHLUP2zqtT1uf7nUDPU

转账完成后请发送截图
```

### 6.4 占位符使用位置

占位符可以在以下字段中使用：

| 配置节 | 字段 | 说明 |
|--------|------|------|
| `services.*.text` | 服务回复文案 | ✅ 支持 |
| `services.*.follow_up` | 服务后续提示 | ✅ 支持 |
| `welcome_message` | 欢迎消息 | ✅ 支持 |
| `menu_welcome` | 菜单欢迎语 | ✅ 支持 |
| `prompts.*` | 系统提示语 | ✅ 支持 |
| `buttons.*` | 按钮文字 | ⚠️ 不建议使用 |

### 6.5 注意事项

⚠️ **占位符区分大小写**：`{PAYMENT_ADDRESS}` 和 `{payment_address}` 不同，请使用大写格式。

⚠️ **占位符格式**：必须使用花括号 `{}`，不要使用其他符号如 `${}` 或 `%s`。

---

## 7. 备份与恢复

### 7.1 备份策略

#### 修改前备份

```bash
# 备份文案配置
cp config/texts.json config/texts.json.backup.$(date +%Y%m%d_%H%M%S)

# 备份环境变量
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
```

#### 定期备份

建议每周进行一次完整备份：

```bash
# 创建备份目录
mkdir -p backups/$(date +%Y%m%d)

# 备份所有配置
cp config/texts.json backups/$(date +%Y%m%d)/
cp .env backups/$(date +%Y%m%d)/
```

### 7.2 恢复方法

#### 恢复文案配置

```bash
# 恢复到最近的备份
cp config/texts.json.backup config/texts.json

# 热加载配置
# 在 Telegram 中发送 /reload
```

#### 恢复环境变量

```bash
# 恢复到最近的备份
cp .env.backup .env

# 重启 Bot
python -m bot.main
```

### 7.3 恢复后验证

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 发送 `/reload` | 提示配置加载成功 |
| 2 | 发送 `/config` | 显示正确的配置信息 |
| 3 | 发送 `/start` | 显示正确的欢迎消息 |
| 4 | 点击服务按钮 | 显示正确的服务文案和地址 |

---

## 8. 故障排查

### 8.1 排查流程图

```
问题出现
    ↓
是否能发送 /reload？
    ↓
┌───是───┐     ┌───否───┐
↓        ↓     ↓        ↓
检查JSON格式   检查Bot是否运行
↓              ↓
格式正确？     Bot运行中？
↓              ↓
┌是─→ 检查字段名    ┌是─→ 检查网络连接
└否─→ 修复JSON格式  └否─→ 重启Bot
```

### 8.2 常见问题排查

#### 问题 1：`/reload` 无响应

**排查步骤：**
1. 检查您是否是管理员（`ADMIN_USER_IDS`）
2. 检查 Bot 是否正在运行
3. 检查网络连接

#### 问题 2：配置加载失败

**排查步骤：**
1. 检查 `config/texts.json` 是否存在
2. 使用 JSON 验证工具检查格式
3. 检查文件编码是否为 UTF-8

#### 问题 3：收款地址未更新

**排查步骤：**
1. 确认已修改 `.env` 文件
2. 确认已**重启 Bot**（不是 `/reload`）
3. 发送 `/config` 查看当前地址

#### 问题 4：文案显示乱码

**排查步骤：**
1. 确认文件保存为 UTF-8 编码
2. 检查是否有未转义的特殊字符
3. 重新复制原始文案

### 8.3 错误日志查看

```bash
# 查看 Bot 运行日志
tail -f bot.log

# 查看最近的错误
grep -i error bot.log | tail -20
```

---

## 9. 常见问题 FAQ

### Q1: 修改文案后需要重启 Bot 吗？

**A**: 不需要。修改 `config/texts.json` 后，只需发送 `/reload` 命令即可热加载，无需重启。

### Q2: 修改收款地址后需要重启 Bot 吗？

**A**: **需要**。收款地址在 `.env` 文件中配置，修改后必须重启 Bot 才能生效。

### Q3: 为什么 `/reload` 提示权限不足？

**A**: 只有在 `.env` 文件中配置的 `ADMIN_USER_IDS` 列表中的用户才能执行管理员命令。请确认您的 Telegram User ID 已添加到该列表。

### Q4: JSON 格式错误如何快速定位？

**A**:
1. 复制 `config/texts.json` 内容
2. 粘贴到 https://jsonlint.com/
3. 点击验证，工具会指出错误行号

### Q5: 占位符 `{PAYMENT_ADDRESS}` 没有被替换？

**A**: 请检查：
1. 占位符是否拼写正确（区分大小写）
2. 占位符是否使用花括号 `{}`
3. `.env` 文件中是否配置了 `PAYMENT_ADDRESS`

### Q6: 如何添加新的服务类型？

**A**: 在 `services` 节点下添加新的服务配置：
```json
{
  "services": {
    "new_service": {
      "type": "auto_reply_with_payment",
      "text": "新服务说明文案",
      "follow_up": "后续提示信息"
    }
  }
}
```
⚠️ 注意：添加新服务还需要修改代码中的按钮配置，建议联系开发人员。

### Q7: 如何修改底部菜单按钮的顺序？

**A**: 按钮顺序由代码逻辑控制，不能通过配置文件修改。如需调整顺序，请联系开发人员。

---

## 📞 技术支持

如遇到无法解决的问题，请联系技术支持并提供以下信息：

1. 错误截图或日志
2. 修改前后的配置文件对比
3. 问题发生的具体步骤

---

> **文档版本**：1.0
> **编写日期**：2024年12月
> **维护者**：土豆担保技术团队


