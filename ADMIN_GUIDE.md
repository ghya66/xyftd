# 土豆担保 Telegram Bot 管理员使用指南

> 本文档适用于土豆担保机器人的管理员，详细介绍管理员权限、配置方法和操作流程。

---

## 目录

- [一、管理员配置](#一管理员配置)
- [二、管理员权限说明](#二管理员权限说明)
- [三、管理员命令](#三管理员命令)
- [四、管理员可执行的操作](#四管理员可执行的操作)
- [五、操作步骤详解](#五操作步骤详解)
- [六、文案配置管理](#六文案配置管理)
- [七、注意事项](#七注意事项)

---

## 一、管理员配置

### 1.1 如何获取 Telegram 用户 ID

在配置管理员之前，您需要先获取自己的 Telegram 用户 ID：

1. 在 Telegram 中搜索 `@userinfobot` 或 `@getmyid_bot`
2. 向该机器人发送任意消息
3. 机器人会回复您的用户 ID（一串数字，如 `123456789`）

### 1.2 在 .env 文件中配置管理员 ID

1. 复制 `.env.example` 文件为 `.env`（如果尚未创建）：
   ```bash
   cp .env.example .env
   ```

2. 编辑 `.env` 文件，找到 `ADMIN_USER_IDS` 配置项：
   ```env
   # 单个管理员
   ADMIN_USER_IDS=123456789
   
   # 多个管理员（用英文逗号分隔）
   ADMIN_USER_IDS=123456789,987654321,111222333
   ```

3. 保存文件后重启机器人使配置生效

### 1.3 多个管理员的配置方法

| 场景 | 配置示例 |
|------|----------|
| 单个管理员 | `ADMIN_USER_IDS=123456789` |
| 两个管理员 | `ADMIN_USER_IDS=123456789,987654321` |
| 多个管理员（含空格） | `ADMIN_USER_IDS=123456789, 987654321, 111222333` |

**注意事项：**
- 多个 ID 之间使用**英文逗号**分隔
- ID 前后的空格会自动去除
- 无效的 ID（非数字）会被自动跳过，并在日志中显示警告

### 1.4 验证配置是否生效

1. 启动机器人：
   ```bash
   python -m bot.main
   ```

2. 观察控制台输出：
   - ✅ 正常：无警告信息
   - ⚠️ 警告：`警告: ADMIN_USER_IDS 未设置，人工客服通知功能将无法使用。`
   - ⚠️ 警告：`警告: 无效的管理员 ID 'xxx'，已跳过`

3. 使用普通用户账号触发人工客服请求，检查管理员是否收到通知

---

## 二、管理员权限说明

### 2.1 管理员可以接收的通知类型

| 通知类型 | 触发条件 | 通知内容 |
|----------|----------|----------|
| 🔔 人工客服请求 | 用户点击需要人工处理的服务 | 用户信息 + 服务类型 + 消息内容 |
| 📷 付款截图转发 | 用户发送付款/上押截图 | 用户信息 + 服务类型 + 图片 |
| 💬 会话消息转发 | 用户在人工会话中发送消息 | 用户消息内容 |

### 2.2 管理员与普通用户的区别

| 功能 | 普通用户 | 管理员 |
|------|----------|--------|
| 使用机器人服务 | ✅ | ✅ |
| 接收客服通知 | ❌ | ✅ |
| 接收用户截图 | ❌ | ✅ |
| 直接回复用户 | ❌ | ✅ |
| 处理退款请求 | ❌ | ✅（必须人工处理） |

### 2.3 管理员的职责范围

1. **及时响应**：收到客服通知后尽快回复用户
2. **验证付款**：核实用户上传的付款截图
3. **执行服务**：完成拉群、开群等操作
4. **处理纠纷**：处理用户投诉和仲裁请求
5. **退款审核**：所有退款请求必须人工审核处理

---

## 三、管理员命令

管理员可以使用以下专属命令来管理机器人：

### 3.1 命令列表

| 命令 | 功能 | 使用场景 |
|------|------|----------|
| `/start` | 开始使用机器人 | 所有用户可见 |
| `/reload` | 热加载配置文件 | 修改 `config/texts.json` 后，无需重启即可生效 |
| `/config` | 查看当前配置 | 检查配置状态、版本信息等 |

### 3.2 命令可见性说明

机器人根据用户身份显示不同的命令菜单：

| 用户类型 | 可见命令 | 说明 |
|----------|----------|------|
| 普通用户 | `/start` | 只能看到基础命令 |
| 管理员 | `/start`, `/reload`, `/config` | 可看到所有命令 |

**技术实现**：
- 使用 Telegram Bot API 的 `BotCommandScope` 机制
- 普通用户使用 `BotCommandScopeDefault` 设置基础命令
- 管理员使用 `BotCommandScopeChat` 设置完整命令菜单

**⚠️ 注意**：
- 管理员 ID 变更后需要重启 Bot 才能更新命令菜单
- 即使普通用户手动输入 `/reload` 或 `/config`，仍会被权限验证拒绝

### 3.3 /reload 命令

**功能**：重新加载 `config/texts.json` 配置文件

**使用方法**：
1. 编辑 `config/texts.json` 文件，修改文案内容
2. 在 Telegram 中向机器人发送 `/reload`
3. 收到成功提示后，新配置立即生效

**成功响应示例**：
```
✅ 配置文件已重新加载

📄 版本: 1.0
🕐 加载时间: 2025-12-07 15:30:45
```

**失败响应示例**：
```
❌ 配置文件加载失败

请检查:
1. config/texts.json 文件是否存在
2. JSON 格式是否正确
```

### 3.4 /config 命令

**功能**：显示当前机器人配置信息

**使用方法**：向机器人发送 `/config`

**响应示例**：
```
⚙️ 土豆担保机器人配置

基础配置
• 机器人名称: 土豆担保
• 收款地址: TWkdsUoYixY3N1Rf...
• 管理员数量: 2 人
• 日志级别: INFO

文案配置
• 配置版本: 1.0
• 加载时间: 2025-12-07 15:30:45
• 按钮数量: 15 个
• 服务数量: 10 个

💡 使用 /reload 命令可以热加载配置文件
```

### 3.5 权限验证

所有管理员命令都会验证执行者身份：
- ✅ 管理员：正常执行命令
- ❌ 非管理员：返回 `⛔ 您没有权限执行此命令`

---

## 四、管理员可执行的操作

### 3.1 服务类型分类

根据系统设计，服务分为两类：

#### 立即转人工的服务（用户点击后直接通知管理员）

| 服务名称 | 默认回复 |
|----------|----------|
| 业务咨询 | "你好，土豆担保人工客服，请问有什么可以帮助您？" |
| 纠纷仲裁 | "你好，土豆担保人工客服，请问有什么可以帮助您？" |
| 资源对接 | "您好，这里是资源对接板块，请问你是主做什么业务，需要找什么类型的资源。" |
| 投诉建议 | "您好，这里是土豆担保工作人员投诉通道..." |
| 销群恢复 | "您是负责人或者公群老板吗？请准备好原上押地址..." |

#### 条件转人工的服务（用户发送付款截图后通知管理员）

| 服务名称 | 处理流程 |
|----------|----------|
| 拉专群 | 用户付款 → 发送截图 → 管理员核实 → 执行拉群 |
| 开公群 | 用户付款 → 发送截图 → 管理员核实 → 执行开群 |
| 买广告 | 用户付款 → 发送截图 → 管理员核实 → 发布广告 |
| 买会员 | 用户付款 → 发送截图 → 管理员核实 → 开通会员 |

### 3.2 退款处理（重要）

> ⚠️ **重要提醒**：系统中**没有自动退款功能**，所有退款请求必须由管理员人工处理！

退款场景包括：
- 销群恢复退押
- 服务取消退款
- 用户投诉退款
- 其他特殊情况

**处理原则**：
1. 核实用户身份和原交易记录
2. 确认退款原因合理
3. 手动操作退款（链上转账）
4. 通知用户退款已处理

---

## 五、操作步骤详解

### 5.1 收到通知后如何查看用户信息

当收到客服请求通知时，消息格式如下：

```
🔔 新客服请求

👤 用户: 张三 (@zhangsan)
📋 服务类型: 拉专群
📷 [含图片]

💬 消息内容:
[发送了付款截图]

---
点击用户链接可直接回复
```

**信息解读**：
- **用户**：显示用户昵称和用户名（@username）
- **服务类型**：用户选择的服务
- **含图片**：表示用户发送了图片（付款截图）
- **消息内容**：用户的文字说明

### 5.2 如何回复用户

**方法一：通过用户名回复**
1. 点击通知消息中的 `@username` 链接
2. 进入与该用户的私聊界面
3. 直接发送消息回复

**方法二：通过用户 ID 回复**
1. 如果用户没有设置用户名，通知会显示 `用户ID: 123456789`
2. 在 Telegram 中无法直接通过 ID 私聊
3. 需要等待用户再次主动发消息

### 5.3 如何处理付款截图

收到用户付款截图后的处理流程：

```
┌─────────────────────────────────────────────────────────┐
│  1. 收到截图通知                                          │
│     ↓                                                    │
│  2. 查看截图，核实付款信息                                  │
│     - 付款金额是否正确                                     │
│     - 收款地址是否正确（TRC20 地址）                        │
│     - 交易是否已上链确认                                   │
│     ↓                                                    │
│  3. 核实通过 → 执行服务（拉群/开群/开通会员等）              │
│     核实失败 → 联系用户说明原因                             │
│     ↓                                                    │
│  4. 通知用户服务已完成                                     │
└─────────────────────────────────────────────────────────┘
```

### 5.4 各类服务请求处理指南

#### 拉专群
1. 确认用户付款截图有效
2. 询问用户需要加入的专群编号或类型
3. 将用户拉入对应专群
4. 通知用户已完成

#### 开公群
1. 确认用户付款截图有效
2. 询问用户公群名称和要求
3. 创建公群并设置用户为管理员
4. 发送群链接给用户

#### 买广告
1. 确认用户付款截图有效
2. 询问广告内容和投放要求
3. 按约定发布广告
4. 发送广告截图给用户确认

#### 买会员
1. 确认用户付款截图有效
2. 在系统中为用户开通会员权限
3. 通知用户会员已生效

#### 销群恢复
1. 确认用户为原群负责人/老板
2. 核实原上押地址和群编号
3. 执行销群恢复操作
4. **退押金必须人工处理**

### 5.5 异常情况处理

#### 通知失败 / 系统繁忙

当系统繁忙或通知发送失败时，用户会看到提示：
> "⚠️ 系统繁忙，客服通知可能有延迟。如长时间未收到回复，请点击下方按钮重新联系客服。"

**管理员应对**：
- 定期检查机器人日志，确保系统正常运行
- 如发现大量通知失败，检查网络和 Bot Token 配置

#### 用户重复点击

系统已内置 1.5 秒防抖机制，防止用户快速重复点击按钮导致重复通知。

---

## 六、文案配置管理

Bot 支持通过 JSON 配置文件管理所有文案，实现无需重启的热加载。

### 6.1 配置文件位置

文案配置文件位于：`config/texts.json`

### 6.2 配置文件结构

```json
{
  "version": "1.0",
  "welcome_message": "招聘欢迎语...",
  "menu_welcome": "进入菜单时的欢迎语...",
  "buttons": {
    "entry": "入口按钮文字",
    "la_zhuan": "拉专群",
    ...
  },
  "services": {
    "la_zhuan": {
      "type": "auto_reply_with_payment",
      "text": "服务说明文案...",
      "follow_up": "付款提示文案（含 {PAYMENT_ADDRESS} 占位符）"
    },
    ...
  }
}
```

### 6.3 占位符说明

| 占位符 | 说明 | 替换值来源 |
|--------|------|------------|
| `{PAYMENT_ADDRESS}` | 收款地址 | `.env` 文件中的 `PAYMENT_ADDRESS` |

### 6.4 修改文案步骤

1. 使用文本编辑器打开 `config/texts.json`
2. 修改需要更改的文案内容
3. 确保 JSON 格式正确（可用在线 JSON 校验工具检查）
4. 保存文件
5. 在 Telegram 中发送 `/reload` 命令
6. 确认收到成功提示

### 6.5 注意事项

- ⚠️ 修改 JSON 文件前建议先备份
- ⚠️ 确保文件使用 UTF-8 编码
- ⚠️ 不要删除必需的配置项
- ⚠️ `{PAYMENT_ADDRESS}` 等占位符不要修改

---

## 七、注意事项

### 7.1 安全提示

| 安全事项 | 说明 |
|----------|------|
| 🔐 保护 Bot Token | 不要在公开场合泄露 Bot Token |
| 🔐 管理员 ID 保密 | 不要公开管理员的用户 ID |
| 🔐 私钥安全 | 退款操作涉及的钱包私钥必须安全存储 |
| 🔐 验证用户身份 | 处理敏感操作前核实用户身份 |
| 🔐 定期检查日志 | 关注异常登录和操作记录 |

### 7.2 常见问题解答

**Q: 为什么我收不到客服通知？**
- 检查 `.env` 中的 `ADMIN_USER_IDS` 是否正确配置
- 检查 `ENABLE_HUMAN_NOTIFICATION` 是否为 `true`
- 确认机器人正在运行且无错误

**Q: 如何添加新的管理员？**
- 编辑 `.env` 文件，在 `ADMIN_USER_IDS` 中添加新管理员 ID
- 多个 ID 用英文逗号分隔
- 重启机器人使配置生效

**Q: 用户说已付款但我没收到截图怎么办？**
- 检查机器人日志是否有转发失败记录
- 让用户重新发送截图
- 手动核实链上交易记录

**Q: 如何处理恶意用户？**
- 记录用户 ID 和行为
- 可在 Telegram 中拉黑该用户
- 必要时向平台举报

**Q: 如何修改机器人的文案？**
- 编辑 `config/texts.json` 文件
- 使用 `/reload` 命令热加载配置
- 无需重启机器人

**Q: 修改收款地址后为什么没有立即生效？**
- 收款地址在 `.env` 文件中配置
- 修改 `.env` 后需要重启机器人才能生效
- `/reload` 命令只能加载 `texts.json` 的更改

### 7.3 故障排查指南

| 故障现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 机器人无响应 | Bot Token 失效 | 从 @BotFather 重新获取 Token |
| 收不到通知 | 管理员 ID 配置错误 | 检查 ID 是否为纯数字 |
| 截图转发失败 | 网络问题 | 检查服务器网络连接 |
| 重复收到通知 | 用户快速点击 | 系统已有防抖机制，正常现象 |
| 配置修改不生效 | 未使用 /reload | 发送 /reload 命令或重启机器人 |
| /reload 失败 | JSON 格式错误 | 检查 texts.json 语法是否正确 |

### 7.4 联系技术支持

如遇到本指南无法解决的问题，请联系技术支持并提供：
1. 机器人日志文件（`bot.log`）
2. 问题发生的时间
3. 具体的错误信息
4. 复现步骤

---

> 📅 文档更新日期：2025-12-07
> 📌 适用版本：土豆担保 Bot v1.0

